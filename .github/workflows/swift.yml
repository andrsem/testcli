name: Swift

env:
  APP_NAME: testcli

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  linux-build:
    name: ${{ matrix.name }}
    runs-on: ubuntu-latest
    container: ${{ matrix.container }}
    continue-on-error: ${{ matrix.experimental == true }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Dynamic Builds ---
          - name: "Linux x86_64"
            container: "swift:6.2.1"
            arch: "x86_64"
            sdk_type: "dynamic"
            artifact_suffix: "linux-x86_64"
            
          - name: "Linux ARM64"
            container: "swift:6.2.1"
            arch: "arm64"
            sdk_type: "dynamic"
            artifact_suffix: "linux-arm64"

          # --- Static SDK Builds ---
          - name: "Static Linux x86_64"
            container: "swift:6.2.1"
            arch: "x86_64"
            sdk_type: "static"
            # Target for the --swift-sdk flag
            sdk_target: "x86_64-swift-linux-musl"
            artifact_suffix: "linux-x86_64-static"

          - name: "Static Linux ARM64"
            container: "swift:6.2.1"
            arch: "arm64"
            sdk_type: "static"
            # Target for the --swift-sdk flag
            sdk_target: "aarch64-swift-linux-musl"
            artifact_suffix: "linux-arm64-static"

          # --- Nightly Test (No Artifacts) ---
          - name: "Linux Nightly"
            container: "swiftlang/swift:nightly-main"
            arch: "x86_64"
            sdk_type: "dynamic"
            experimental: true
            skip_release: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set Tag Version
        if: startsWith(github.ref, 'refs/tags/')
        run: echo "TAG_VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Swift version
        run: swift --version

      # Only runs for ARM64 jobs
      - name: Install QEMU (ARM64)
        if: matrix.arch == 'arm64'
        run: |
          apt-get update
          apt-get install -y qemu-user-static

      # Only runs for Static SDK jobs
      - name: Install Static SDK
        if: matrix.sdk_type == 'static'
        run: |
          swift sdk install https://download.swift.org/swift-6.2.1-release/static-sdk/swift-6.2.1-RELEASE/swift-6.2.1-RELEASE_static-linux-0.0.1.artifactbundle.tar.gz --checksum 08e1939a504e499ec871b36826569173103e4562769e12b9b8c2a50f098374ad

      - name: Run Tests
        run: swift test

      - name: Build Release
        if: matrix.skip_release != true
        run: |
          if [ "${{ matrix.sdk_type }}" == "static" ]; then
            swift build -c release --swift-sdk ${{ matrix.sdk_target }}
          else
            swift build -c release
          fi
        timeout-minutes: 60


      - name: Prepare Artifact
        if: matrix.skip_release != true
        run: |
          # Determine the correct binary path using --show-bin-path
          if [ "${{ matrix.sdk_type }}" == "static" ]; then
            BIN_PATH=$(swift build -c release --swift-sdk ${{ matrix.sdk_target }} --show-bin-path)
          else
            BIN_PATH=$(swift build -c release --show-bin-path)
          fi

          echo "Packaging artifact from: $BIN_PATH"
          ARCHIVE_NAME="${{ env.APP_NAME }}-${{ matrix.artifact_suffix }}-${{ env.TAG_VERSION || github.sha }}.tar.gz"
          mkdir -p artifacts
          tar -C "$BIN_PATH" -czf artifacts/$ARCHIVE_NAME ${{ env.APP_NAME }}

      - name: Upload Artifact
        if: matrix.skip_release != true
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_suffix }}-${{ env.TAG_VERSION || github.sha }}
          path: artifacts/*.tar.gz

  macos-build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "macOS x86_64"
            runner: "macos-13" # Intel
            arch: "x86_64"
            artifact_suffix: "macos-x86_64"
          - name: "macOS ARM64"
            runner: "macos-14" # Apple Silicon
            arch: "arm64"
            artifact_suffix: "macos-arm64"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set Tag Version
        if: startsWith(github.ref, 'refs/tags/')
        run: echo "TAG_VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Install Swift 6.2.1
        run: |
          curl -L https://download.swift.org/swift-6.2.1-release/xcode/swift-6.2.1-RELEASE/swift-6.2.1-RELEASE-osx.pkg -o swift.pkg
          sudo installer -pkg swift.pkg -target /
          export PATH="/Library/Developer/Toolchains/swift-6.2.1-RELEASE.xctoolchain/usr/bin:$PATH"
          echo "/Library/Developer/Toolchains/swift-6.2.1-RELEASE.xctoolchain/usr/bin" >> $GITHUB_PATH

      - name: Build Release
        run: swift build -c release --arch ${{ matrix.arch }}
        timeout-minutes: 60

      - name: Prepare Artifact
        run: |
          ARCHIVE_NAME="${{ env.APP_NAME }}-${{ matrix.artifact_suffix }}-${{ env.TAG_VERSION || github.sha }}.tar.gz"
          mkdir -p artifacts
          tar -C .build/release -czf artifacts/$ARCHIVE_NAME ${{ env.APP_NAME }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_suffix }}-${{ env.TAG_VERSION || github.sha }}
          path: artifacts/*.tar.gz

  publish-release:
    name: Publish Release
    needs: [linux-build, macos-build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Flatten artifacts
        run: |
          mkdir -p flat-artifacts
          find release-artifacts -type f -name "*.tar.gz" -exec cp {} flat-artifacts/ \;
          ls -la flat-artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: flat-artifacts/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
